# service-neurahive

## Getting started

If you are likely going to commit to any submodule, make sure to follow their readme to install
any dev dependency and necessary runtimes. 

You must install node, if don't already have it.
```bash
sudo apt update
sudo apt upgrade

# installs nvm (Node Version Manager)
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.7/install.sh | bash

# download and install Node.js (you may need to restart the terminal)
nvm install 20

# verifies the right Node.js version is in the environment
node -v # should print `v20.18.1`

# verifies the right npm version is in the environment
npm -v # should print `10.8.2`
```
Now you will run theses commands to set up your commit envinronment to follow our commit, version and changelog patterns.
```bash
npm ci
npx husky init
echo "npx commitlint --version" > .husky/pre-commit
echo "npx --no -- commitlint --verbose --config commitlint.config.js --edit \$1" > .husky/commit-msg
echo "export HUSKY=0
npm run changelog
export HUSKY=1" > .husky/pre-push
```

Make a copy of the `.env.example` file and rename it to `.env`
```bash
cp .env.example .env
```
Change the following variable in the `.env` file to:
```dotenv
DATABASE_URI=postgresql+asyncpg://postgres:password@localhost:5432/neurahive
```
### Setting up you development environment
Make sure `python 3.12` or newer is installed:
```bash
python3 -V
```
**If you are not:**
Install python 3.12 or later, your machine probably includes it by default but you may not have this python version installed, you can install it via apt using theses commands:
```bash
sudo apt update
sudo apt upgrade
sudo add-apt-repository ppa:deadsnakes/ppa
sudo apt update
sudo apt install python3.12
```
It might be necessary to install pip as well, you may do so by running:
```bash
sudo apt install python3.12-distutils
wget https://bootstrap.pypa.io/get-pip.py
sudo python3.12 get-pip.py
```
Now, create a virtual environment for this project and install its dependencies with:
```bash
sudo apt install python3.12-venv
python3.12 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
```

This file is automatically generated during deployment, but locally you still have to create it, the values you put here have do not affect how the system works.
### Installing and configuring Docker
Install Docker:
```bash
# FONTE: https://docs.docker.com/engine/install/ubuntu/
sudo apt update
sudo apt install ca-certificates curl
sudo install -m 0755 -d /etc/apt/keyrings
sudo curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
sudo chmod a+r /etc/apt/keyrings/docker.asc

# Add the repository to Apt sources:
echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo "$VERSION_CODENAME") stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
sudo apt update
sudo apt-get install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
sudo docker run --name postgres -p 5432:5432 -e POSTGRES_PASSWORD=password -d postgres:16
```
#### Running this project with docker
Just run:
```bash
docker-compose up --build
```
*NOTE*: Do not change their specification.

### Installing and configuring DBeaver
Access the website https://dbeaver.io/download/, download and install DBeaver
- Open DBeaver (if asked to create an example database, click no)
- When opening a window to connect a database, click on PostgreSQL and Next (If it doesn't open, click on Database > new connection)
- Put the following configuration:
  - Host: localhost
  - Port: 5432
  - Database: postgres (check a opção `View all databases`)
  - Authentication: Database Native
  - Username: postgres
  - Password: password
- Click on `Test connection` (If necessary, click on Download to download the driver)
- Click `Finish`
- If it worked, you have a `postgres` database and a `public` schema

**Create a database `neurahive`**
- Right click on `database` and `create database`
- Just enter the database name `copa` and click OK
- Right click on `neurahive` and click `set as default`

### Creating and managing your database (**For future reference**)
We use alembic to manage database migrations. To start your local database versioning run this command:
```bash
source .venv/bin/activate
alembic init alembic
```

You are probably using a postgres dump as the base of your database, in that case you will need to delete all rows inside the table `alembic_version` or run the following command:
```bash
alembic stamp head --purge
```
#### Creating a migration
Alembic can programmatically create a migration for you, use this command to generate a migration:
```bash
source .venv/bin/activate
alembic revision --autogenerate -m "a basic description"
```
A description is but optional however it might prove good to maintain them so that you know the order and which certain changes happened in your local database.
Then, to *commit* them to your database run:
```bash
source .venv/bin/activate
alembic upgrade head
```

### Checking your code for lint and type errors
By installing the `tests/requirements.txt` file, you should have these 2 libraries included in your environment: **ruff** and **mypy**. To use them, simply activate your virtual environment and run:
```bash
source .venv/bin/activate
mypy .
# and
ruff check .
```

## Commits
When committing your code you **MUST** add one of the following tags to the start of your commit:
* fix: You fixed a bug;
* feature: You added new functionality, module or changed how another feature works;
* refactor: You reimplemented a functionality;
* docs: You added documentation to a piece of code, this readme ou changed the changelog template;
* ci: You modified in any way the file `gitlab-ci`;
* test: You added new tests, changed existing ones or update test dependencies;
* security: You added or fixed a security flaw;
* deprecated: You set a feature as deprecated; or
* remove: You removed a feature.
<br>

When you are ready to create a merge request, simply push your changes to github and create a merge request from the web page. That's it.
